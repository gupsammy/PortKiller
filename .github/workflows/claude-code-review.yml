name: Claude Code Review

on:
  pull_request:
    types: [opened, ready_for_review, reopened, synchronize]
    # Only run on Rust source changes
    paths:
      - "src/**/*.rs"
      - "Cargo.toml"
      - "Cargo.lock"

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # Enable inline comments
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Enable progress tracking for better UX
          track_progress: true

          # Allow all bots to trigger reviews
          allowed_bots: "*"

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Perform a focused, pragmatic code review with a high-velocity builder mindset.

            ## 1. Critical Issues Only (Must Block)
            - **Security vulnerabilities**:
              - Unsafe Rust code without justification
              - Process/signal handling bugs that could cause crashes
              - Permission/privilege escalation issues (macOS system tray app)
              - Command injection in `lsof` or `ps` parsing

            - **Core experience breakers**:
              - App won't build or crashes on startup
              - Tray icon doesn't show or is broken
              - Process termination doesn't work
              - Memory leaks or runaway threads
              - UI freezing or unresponsiveness

            - **Visual/UX regressions**:
              - Icon rendering issues (template mode, dark/light theme)
              - Menu broken or confusing
              - Tooltip feedback unclear or missing

            ## 2. Nice-to-Haves (Don't Block, Just Suggest)
            - Code organization and readability improvements
            - Better error messages or logging
            - Performance optimizations that aren't critical
            - Additional features or polish

            ## 3. Explicitly OK to Skip
            - Perfect error handling for unlikely edge cases
            - Exhaustive testing of all code paths
            - Over-abstraction or premature optimization
            - Idiomatic Rust patterns if current code works fine
            - Documentation for obvious code
            - Supporting non-macOS platforms (this is macOS-only)

            ## Review Approach
            1. Use inline comments for specific issues (file/line references)
            2. Use top-level comment for summary and critical findings
            3. Be constructive and educational - explain *why* something matters
            4. Acknowledge what's done well
            5. If no critical issues found, say so clearly

            ## Rust-Specific Focus Areas
            - Thread safety (crossbeam channels, Arc/Mutex usage)
            - Signal handling correctness (SIGTERM/SIGKILL flow)
            - Error propagation (anyhow usage)
            - macOS API usage (lsof, ps, kill commands)
            - System tray integration (tray-icon, winit event loop)

            Use the repository's CLAUDE.md for project-specific architecture details.

            **If everything looks good and works, say so clearly and approve!**

          # Tools for comprehensive review with inline comments and gh CLI
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh:*), Bash(cargo:*)"
